{% extends "navigation_bar.html" %}

{% block title %}Orders{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">Orders Management</h1>

    {% if error %}
    <div class="alert alert-danger" role="alert">
        {{ error }}
    </div>
    {% endif %}

    {% if success %}
    <div class="alert alert-success" role="alert">
        {{ success }}
    </div>
    {% endif %}

    <!-- Search and Filter Section -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Search by Order ID"
                       onkeyup="searchOrders()">
                <button class="btn btn-outline-secondary" type="button" onclick="searchOrders()">Search</button>
            </div>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="statusFilter" onchange="filterOrders()">
                <option value="all">All Statuses</option>
                <option value="PENDING">Pending</option>
                <option value="PAID">Paid</option>
                <option value="CANCELLED">Cancelled</option>
            </select>
        </div>
        <div class="col-md-4">
            <select class="form-select" id="sortOption" onchange="sortOrders()">
                <option value="date-desc">Date (Newest First)</option>
                <option value="date-asc">Date (Oldest First)</option>
                <option value="price-desc">Price (High to Low)</option>
                <option value="price-asc">Price (Low to High)</option>
            </select>
        </div>
    </div>

    <!-- Orders Display -->
    {% if orders %}
    <div class="table-responsive">
        <table class="table table-hover" id="ordersTable">
            <thead class="table-light">
            <tr>
                <th>Order ID</th>
                <th>Date</th>
                <th>Status</th>
                <th>Total Items</th>
                <th>Total Price</th>
                <th>User ID</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            {% for order_id, order in orders.items() %}
            <tr class="order-row"
                data-order-id="{{ order_id }}"
                data-status="{{ order.get('status', '') }}"
                data-date="{{ order.get('orderDate', '') }}"
                data-price="{{ order.get('totalPrice', 0) }}">
                <td>{{ order_id }}</td>
                <td>
                    {% if order.get('orderDate') %}
                    {{ order.orderDate | datetime }}
                    {% else %}
                    No date
                    {% endif %}
                </td>
                <td>
                        <span class="status-label">
                            {% if order.get('status') == 'PENDING' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                            {% elif order.get('status') == 'PAID' %}
                            <span class="badge bg-success">Paid</span>
                            {% elif order.get('status') == 'CANCELLED' %}
                            <span class="badge bg-danger">Cancelled</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ order.get('status', 'Unknown') }}</span>
                            {% endif %}
                        </span>
                </td>
                <td>{{ order.get('items')|length }}</td>
                <td>${{ "%.2f"|format(order.get('totalPrice', 0)|float) }}</td>
                <td>{{ order.get('userUId', 'Unknown') }}</td>
                <td>
                    <select class="form-select status-dropdown" data-order-id="{{ order_id }}"
                            onchange="updateStatus(this)">
                        <option value="PENDING" {% if order.get(
                        'status') == 'PENDING' %}selected{% endif %}>Pending</option>
                        <option value="PAID" {% if order.get(
                        'status') == 'PAID' %}selected{% endif %}>Paid</option>
                        <option value="CANCELLED" {% if order.get(
                        'status') == 'CANCELLED' %}selected{% endif %}>Cancelled</option>
                    </select>
                    {% if order.get('status') == 'CANCELLED' %}
                    <button class="btn btn-danger btn-sm delete-order-btn mt-2" data-order-id="{{ order_id }}"
                            onclick="deleteOrder('{{ order_id }}')">
                        Delete Order
                    </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        No orders available.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
    function searchOrders() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const rows = document.getElementsByClassName('order-row');
        let hasVisibleItems = false;

        for (let row of rows) {
            const orderId = row.getAttribute('data-order-id').toLowerCase();
            const shouldShow = orderId.includes(searchTerm);

            row.style.display = shouldShow ? '' : 'none';
            if (shouldShow) hasVisibleItems = true;
        }

        document.getElementById('noResults').classList.toggle('d-none', hasVisibleItems);
    }

    function filterOrders() {
        const filter = document.getElementById('statusFilter').value;
        const rows = document.getElementsByClassName('order-row');

        for (let row of rows) {
            const status = row.getAttribute('data-status');
            row.style.display = (filter === 'all' || status === filter) ? '' : 'none';
        }
    }

    function sortOrders() {
        const sortOption = document.getElementById('sortOption').value;
        const tableBody = document.querySelector('#ordersTable tbody');
        const rows = Array.from(tableBody.getElementsByClassName('order-row'));

        rows.sort((a, b) => {
            const dateA = parseFloat(a.getAttribute('data-date')) || 0;
            const dateB = parseFloat(b.getAttribute('data-date')) || 0;
            const priceA = parseFloat(a.getAttribute('data-price')) || 0;
            const priceB = parseFloat(b.getAttribute('data-price')) || 0;

            switch (sortOption) {
                case 'date-desc':
                    return dateB - dateA;
                case 'date-asc':
                    return dateA - dateB;
                case 'price-desc':
                    return priceB - priceA;
                case 'price-asc':
                    return priceA - priceB;
                default:
                    return 0;
            }
        });

        rows.forEach(row => tableBody.appendChild(row));
    }

    function updateStatus(selectElement) {
        const orderId = selectElement.getAttribute('data-order-id');
        const newStatus = selectElement.value;

        fetch(`/orders/${orderId}/update-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `new_status=${newStatus}`
        })
        .then(response => {
            if (response.ok) {
                const row = selectElement.closest('tr');
                const statusLabel = row.querySelector('.status-label');
                let labelHTML = '';

                if (newStatus === 'PENDING') {
                    labelHTML = '<span class="badge bg-warning text-dark">Pending</span>';
                } else if (newStatus === 'PAID') {
                    labelHTML = '<span class="badge bg-success">Paid</span>';
                } else if (newStatus === 'CANCELLED') {
                    labelHTML = '<span class="badge bg-danger">Cancelled</span>';
                } else {
                    labelHTML = `<span class="badge bg-secondary">${newStatus}</span>`;
                }

                statusLabel.innerHTML = labelHTML;
                alert('Order status updated successfully!');
            } else {
                alert('Failed to update order status.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the order status.');
        });
    }

    function deleteOrder(orderId) {
        if (confirm('Are you sure you want to delete this order?')) {
            fetch(`/orders/${orderId}/delete`, {
                method: 'POST',
            })
            .then(response => {
                if (response.ok) {
                    alert('Order deleted successfully!');
                    document.querySelector(`[data-order-id="${orderId}"]`).remove();
                } else {
                    alert('Failed to delete order.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the order.');
            });
        }
    }
</script>
{% endblock %}